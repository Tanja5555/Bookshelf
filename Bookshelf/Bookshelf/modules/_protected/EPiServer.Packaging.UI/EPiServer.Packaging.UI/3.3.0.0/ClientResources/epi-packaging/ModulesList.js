//>>built
define("epi-packaging/ModulesList",["dojo","dijit","dojo/cookie","dijit/_Widget","dijit/_TemplatedMixin","dojox/widget/Standby","epi/shell/XhrWrapper","epi-packaging/ModuleSummary","epi/i18n!epi/packaging/nls/EPiServer.Packaging.UI.ModulesList"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9){return _1.declare([_4,_5],{res:_9,antiForgeryData:null,templateString:"<div class=\"epi-listingContainer\"><ul data-dojo-attach-point=\"_modulesListPlaceholder\" class=\"epi-advancedListing\"></ul></div>",listItemTemplateString:null,listingUrl:null,feedName:null,hideModuleInListOnAction:false,emptyListMessage:"No add-on found.",_dataStore:null,_listItems:null,_standbyWigdet:null,constructor:function(){this._xhr=new _7();},startup:function(){if(this._started){return;}this._standbyWigdet=this._createStandbyWidget();document.body.appendChild(this._standbyWigdet.domNode);this._standbyWigdet.startup();this.inherited(arguments);},_createStandbyWidget:function(){return new dojox.widget.Standby({target:this._modulesListPlaceholder});},destroy:function(){this._destroyModuleList();this._standbyWigdet.destroyRecursive(false);this.inherited(arguments);},updateView:function(){this._listModules(true);},onSiteRestartRequired:function(){},onError:function(_a){},onSuccess:function(_b){},onModuleActionPerformed:function(){},_listModules:function(_c){if(this.listingUrl==""){return;}if(!this._dataStore||_c){var _d={feedName:this.feedName};this.antiForgeryData.AddAntiforgeryToken(_d);this._standbyWigdet.show();this._xhr.xhrPost({content:_d,url:this.listingUrl,handleAs:"json",load:_1.hitch(this,function(_e,_f){if(!_e){return;}else{if(_e.errors&&_e.errors.length>0){this._showErrors(_e.errors);}this._dataStore=new _1.store.Memory({data:_e.modules});this._buildModuleList();}}),error:_1.hitch(this,function(_10,_11){var _12=_1.replace(this.res.addonlistreaderror,{error:_10});this._showErrors([_12]);_1.publish("onServerError",[_11]);}),handle:_1.hitch(this,function(_13,_14){this._standbyWigdet.hide();})});}else{this._buildModuleList();}},_buildModuleList:function(){var _15=this._dataStore.query({},{sort:[{attribute:"title",descending:false},{attribute:"versionMajor",descending:true},{attribute:"versionMinor",descending:true},{attribute:"versionBuild",descending:true},{attribute:"versionRevision",descending:true},{attribute:"versionSpecial",descending:false}]});this._renderModules(_15);},_createModuleSummary:function(_16,_17){var li=_1.create("li",{"class":"clearfix"},_17);var div=_1.create("div",{},li);return new _8(_16,div);},_renderModules:function(_18){_1.empty(this._modulesListPlaceholder);this._destroyModuleList();if(_18.length==0){this._showEmptyListMessage();return;}_1.forEach(_18,function(_19,i){var _1a={module:_19,antiForgeryData:this.antiForgeryData,itemIndex:i};if(this.listItemTemplateString){_1a.templateString=this.listItemTemplateString;}var _1b=this._createModuleSummary(_1a,this._modulesListPlaceholder);_1b.startup();this._connectModuleSummaryEvents(_1b);},this);},_connectModuleSummaryEvents:function(_1c){var _1d=this.connect(_1c,"onInstall",function(_1e){this._onModuleAction(_1e);var _1f=_1.replace(this.res.installsuccess,_1e.module);this.onSuccess([_1f]);this._ensureReload();});var _20=this.connect(_1c,"onUninstall",function(_21){this._onModuleAction(_21);var _22=_1.replace(this.res.uninstallsuccess,_21.module);this.onSuccess([_22]);this._ensureReload();});var _23=this.connect(_1c,"onUpdate",function(_24){this._onModuleAction(_24);var _25=_1.replace(this.res.updatesuccess,_24.module);this.onSuccess([_25]);this._ensureReload(_24);});var _26=this.connect(_1c,"onEnable",function(_27){this._onModuleAction(_27);var _28=_1.replace(this.res.enablesuccess,_27.module);this.onSuccess([_28]);this._ensureReload(_27);});var _29=this.connect(_1c,"onDisable",function(_2a){this._onModuleAction(_2a);var _2b=_1.replace(this.res.disablesuccess,_2a.module);this.onSuccess([_2b]);this._ensureReload(_2a);});var _2c=this.connect(_1c,"onInstallError",function(_2d){this.onModuleActionPerformed();var _2e=this._getErrorMessages(this.res.installationerror,_2d.module);this._showErrors(_2e);});var _2f=this.connect(_1c,"onUninstallError",function(_30){this.onModuleActionPerformed();var _31=this._getErrorMessages(this.res.uninstallationerror,_30.module);this._showErrors(_31);});var _32=this.connect(_1c,"onUpdateError",function(_33){this.onModuleActionPerformed();var _34=this._getErrorMessages(this.res.updateerror,_33.module);this._showErrors(_34);});var _35=this.connect(_1c,"onEnableError",function(_36){this.onModuleActionPerformed();var _37=this._getErrorMessages(this.res.enableerror,_36.module);this._showErrors([_37]);});var _38=this.connect(_1c,"onDisableError",function(_39){this.onModuleActionPerformed();var _3a=this._getErrorMessages(this.res.disableerror,_39.module);this._showErrors([_3a]);});var _3b={widget:_1c,handlers:[_1d,_20,_23,_26,_29,_2c,_2f,_32,_35,_38]};this._listItems.push(_3b);},_getErrorMessages:function(_3c,_3d){var _3e=[_1.replace(_3c,_3d)];if(_3d.errors&&_3d.errors.length){_3e=_3e.concat(_3d.errors);}return _3e;},_ensureReload:function(){_1.publish("onReloadRequired");},_onModuleAction:function(_3f){if(this.hideModuleInListOnAction){this._removeModuleFromList(_3f);}this.onSiteRestartRequired();this.updateView();this.onModuleActionPerformed();},_removeModuleFromList:function(_40){var _41=_1.filter(this._listItems,function(_42){return _42.widget==_40;});_1.forEach(_41,function(_43,i){var _44=_43.widget.domNode.parentNode;this._destroyListItem(_43);var _45=_1.indexOf(this._listItems,_43);if(_45>-1){this._listItems.splice(_45,1);}_1.destroy(_44);},this);if(this._listItems.length==0){this._showEmptyListMessage();}},_destroyModuleList:function(){_1.forEach(this._listItems,function(_46,i){this._destroyListItem(_46);},this);this._listItems=[];},_destroyListItem:function(_47){_1.forEach(_47.handlers,function(_48){this.disconnect(_48);},this);_47.widget.destroyRecursive(false);},_showErrors:function(_49){this.onError(_49);},_showEmptyListMessage:function(){var li=_1.create("li",{},this._modulesListPlaceholder);var div=_1.create("div",{innerHTML:"<span>"+this.emptyListMessage+"</span>"},li);_1.addClass(div,"emptyListMessageContainer");}});});