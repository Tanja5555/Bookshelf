//>>built
define("epi-cms/content-approval/viewmodels/ContentApprovalViewModel",["dojo/_base/declare","dojo/_base/lang","dojo/on","dojo/when","epi/epi","epi/dependency","epi/shell/DialogService","epi-cms/content-approval/ApprovalDefinitionStatus","epi-cms/content-approval/viewmodels/ApprovalStepViewModel","epi/shell/command/withConditionalConfirmation","dojo/Stateful","epi/shell/DestroyableByKey","epi/shell/_ContextMixin","epi-cms/content-approval/command/SaveApprovalDefinition","epi-cms/content-approval/command/CancelChanges","epi/shell/store/SortableMemory","dojo/store/Observable","epi/i18n!epi/nls/episerver.cms.contentapproval","epi/i18n!epi/nls/episerver.cms.languageselector","epi/i18n!epi/nls/episerver.shared.action"],function(_1,_2,on,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13){return _1([_a,_b,_c],{approvalSteps:null,approvalService:null,userStore:null,commands:null,isDirty:false,selectedLanguage:null,currentContentLink:null,isValid:true,isReadOnly:false,languages:null,filterOptions:null,languageOptions:null,showValidations:false,status:_7.inheritEnabled,_approvalStepsQuery:null,_originalDefinition:null,_validationMessageIds:[],_contextService:null,_messageService:null,constructor:function(_14,_15,_16,_17,_18){this.approvalService=_15||_5.resolve("epi.cms.ApprovalService");this._contextService=_16||_5.resolve("epi.shell.ContextService");this._messageService=_17||_5.resolve("epi.shell.MessageService");this.userStore=_18||_5.resolve("epi.storeregistry").get("epi.cms.notification.users");},postscript:function(){this.inherited(arguments);_3(this.getCurrentContext()).then(this.contextChanged.bind(this));},destroy:function(){this.inherited(arguments);this._removeEventListeners();},contextChanged:function(_19){this.set("currentContentLink",_19.id);this.approvalService.getDefinition(_19.id).then(this.loadApprovalDefinition.bind(this));},createApprovalStep:function(_1a){if(!this._canEditApprovalSteps()){return;}var _1b=this.approvalSteps,_1c=_1b.getSibling(_1a),_1d;_1d=new _8({languages:this.languages,approvers:[],userStore:this.userStore,showValidations:this.showValidations});this._addEventListeners(_1d);_1b.add(_1d,{before:_1c});},inheritDefinition:function(){var _1e=this.get("currentContentLink"),_1f=this.status;this.set("status",_7.inheritEnabled);return this.approvalService.inheritDefinition(_1e).then(this.loadApprovalDefinition.bind(this)).otherwise(this.set.bind(this,"status",_1f));},moveApprovalStep:function(_20,up){if(!this._canEditApprovalSteps()){return;}var _21=this.approvalSteps,_22=_21.getSibling(_20,up);if(!_22){return;}if(!up){_22=_21.getSibling(_22);}_21.put(_20,{before:_22});},removeApprovalStep:function(_23){if(!this._canEditApprovalSteps()){return;}if(_23.canBeDeleted){this.approvalSteps.remove(_23.id);}},loadApprovalDefinition:function(_24){this._originalDefinition=null;this.set({languages:_24.languages,status:_24.status,isReadOnly:_24.isReadOnly,showValidations:false});this._createApprovalSteps(_24.approvalSteps);this._originalDefinition=this.serialize();},saveApprovalDefinition:function(){var _25=this.serialize();return this.approvalService.saveDefinition(_25).then(this.loadApprovalDefinition.bind(this));},serialize:function(){var _26=this.approvalSteps.data.map(function(_27){return _27.serialize();});return {contentLink:this.currentContentLink,approvalSteps:_26,status:this.status};},validate:function(){var _28=null;this.approvalSteps.data.forEach(function(_29){_29.validate();});if(this._stepsMissingApprover().length>0){_28={level:"error",dialog:{description:_11.validationmessage.notenoughapproversmessage.description}};}else{if(this._stepsMissingLanguageApprover().length>0){_28={level:"warning",dialog:{title:_11.validationmessage.notenoughlanguagesmessage.title,description:_11.validationmessage.notenoughlanguagesmessage.description,confirmActionText:_11.action.saveanyway,cancelActionText:_13.cancel}};}}return _28;},enable:function(){this.set("status",_7.enabled);},disable:function(){this.set("showValidations",false);this.set("status",_7.disabled);return this.saveApprovalDefinition().otherwise(function(){this.set("showValidations",true);this.enable();}.bind(this));},_createApprovalSteps:function(_2a){var _2b=(_2a||[this._createEmptyStep()]).map(this._createStepViewModel.bind(this)),_2c=_10(new _f({data:_2b}));this.set("approvalSteps",_2c);this.set("isDirty",false);this._approvalStepsQuery=_2c.query();this._updateApprovalSteps();this.destroyByKey("observeHandle");this.ownByKey("observeHandle",this._approvalStepsQuery.observe(function(){this._updateApprovalSteps();}.bind(this)));},_createEmptyStep:function(){return {approvers:[]};},_createStepViewModel:function(_2d,_2e){_2d=_2.clone(_2d);var _2f=new _8({id:_2e,languages:this.languages,approvers:_2d.approvers,name:_2d.name,userStore:this.userStore});this._addEventListeners(_2f);return _2f;},_updateApprovalSteps:function(){var _30=this._approvalStepsQuery;if(_30){var _31=_30.length>1,_32=!this._canEditApprovalSteps(),_33=this.selectedLanguage;_30.forEach(function(_34){_34.set({canBeDeleted:_31,isReadOnly:_32});_34.filterApprovers(_33);});this._onApprovalStepsChanged();}},_resetValidationMessageIds:function(){this._validationMessageIds.forEach(_2.hitch(this,function(_35){this._messageService.remove({id:_35});}));this._validationMessageIds=[];if(this.showValidations){this._approvalStepsQuery.forEach(_2.hitch(this,function(_36){var _37;if(!_36.isValid){if(_36.validationMessage.level==="error"){_37={level:"error",text:_36.validationMessage.value};}else{if(_36.validationMessage.level==="warning"){_37={level:"warn",text:_36.validationMessage.value};}}var _38=this._messageService.put(_37.level,_37.text,"epi.cms.approval",this.currentContentLink);this._validationMessageIds.push(_38);}}));}},_onApprovalStepsChanged:function(){this._resetValidationMessageIds();this._validateFilterOptions();var _39=this.serialize();var _3a=_4.areEqual(_39,this._originalDefinition);this._originalDefinition&&this.set("isDirty",!_3a);},_addEventListeners:function(_3b){this.own(_3b.on("create-step",this.createApprovalStep.bind(this)),_3b.on("remove-step",this.removeApprovalStep.bind(this)),_3b.on("change",this._onApprovalStepsChanged.bind(this)),_3b.watch("isValid",this._onApprovalStepsChanged.bind(this)));},_canEditApprovalSteps:function(){return !this.isReadOnly&&this.status===_7.enabled;},_commandsGetter:function(){if(this.commands===null){this.commands=[new _d({model:this,order:10}),new _e({model:this,order:20})];}return this.commands;},_createLanguageOptions:function(_3c){if(!_3c){this.set("languageOptions",null);this.set("filterOptions",null);return;}var _3d=_3c.map(function(_3e){return {label:_3e.text,value:_3e.value};});this.set("languageOptions",_3d);var _3f=_2.clone(_3d);_3f.unshift(this._getDefaultLanguageOption());this.set("filterOptions",_3f);},_getDefaultLanguageOption:function(){return {label:_12.alllanguages,value:"",selected:true};},_validateFilterOptions:function(){if(!this.filterOptions){return;}var _40=this._stepsMissingLanguageApprover();this.filterOptions.forEach(function(_41){_41.isValid=_40.every(function(_42){return _42.validationMessage.languages.indexOf(_41.value)===-1;});});this.set("filterOptions",this.filterOptions);},_stepsMissingApprover:function(){return this.approvalSteps.data.filter(function(_43){return !_43.isValid&&!_43.validationMessage.languages;});},_stepsMissingLanguageApprover:function(){return this.approvalSteps.data.filter(function(_44){return !_44.isValid&&_44.validationMessage.languages;});},_isDirtySetter:function(_45){this.isDirty=_45;if(!_45){this._removeEventListeners();return;}if(this._interceptor){return;}this._beforeUnloadHandler=on(window,"beforeunload",function(e){var _46=_11.command.cancelchanges.description;e.returnValue=_46;return _46;});this._interceptor=this._contextService.registerRequestInterceptor(function(){var _47={title:_11.command.cancelchanges.title,description:_11.command.cancelchanges.description};return _6.confirmation(_47).then(this._removeEventListeners.bind(this));}.bind(this));},_isReadOnlySetter:function(_48){this.isReadOnly=_48;this._updateApprovalSteps();},_languagesSetter:function(_49){this.languages=_49;this._createLanguageOptions(this.languages);this._updateApprovalSteps();},_selectedLanguageSetter:function(_4a){this.selectedLanguage=!_4a?null:_4a;this._updateApprovalSteps();},_showValidationsSetter:function(_4b){this.showValidations=_4b;if(this.approvalSteps&&this.approvalSteps.data){this.approvalSteps.data.forEach(function(_4c){_4c.set("showValidations",_4b);});}},_statusSetter:function(_4d){this.status=_4d;this._updateApprovalSteps();},_removeEventListeners:function(){this._interceptor&&this._interceptor.remove();this._interceptor=null;this._beforeUnloadHandler&&this._beforeUnloadHandler.remove();this._beforeUnloadHandler=null;}});});