//>>built
define("epi-cms/contentediting/ContentViewModel",["dojo/_base/array","dojo/_base/connect","dojo/_base/declare","dojo/Deferred","dojo/_base/lang","dojo/topic","dojo/on","dojo/when","dojo/promise/all","dojo/Stateful","dijit/Destroyable","dgrid/List","dgrid/extensions/DijitRegistry","epi","epi/dependency","epi/shell/UndoManager","epi/shell/conversion/ObjectConverterRegistry","epi/shell/widget/dialog/Alert","epi/shell/Stateful","../ApplicationSettings","./ContentActionSupport","./ContentEditingValidator","./ContentModelServerSync","./Operation","epi/i18n!epi/cms/nls/episerver.cms.contentediting","epi/i18n!epi/cms/nls/episerver.cms.components.versions"],function(_1,_2,_3,_4,_5,_6,on,_7,_8,_9,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,res,_18){return _3([_9,_a],{contentModel:null,metadata:null,syncService:null,editorFactory:null,validator:null,contentDataStore:null,profileHandler:null,languageContext:null,enableAutoSave:true,_converterRegistry:null,_contentVersionStore:null,_syncRetryTimeout:60000,undoManager:null,contextTypeName:"",contentLink:null,contentData:null,viewName:null,isCreatingNewVersion:false,hasUndoSteps:false,hasRedoSteps:false,isValid:true,hasPendingChanges:false,lastSaved:null,isSaved:true,isSaving:false,isOnline:true,hasErrors:false,isChangingContentStatus:false,isSuspended:false,constructor:function(){this.contentModel=new _12();},postscript:function(){this.inherited(arguments);this.profileHandler=this.profileHandler||_e.resolve("epi.shell.Profile");this.metadataManager=this.metadataManager||_e.resolve("epi.shell.MetadataManager");this.projectService=this.projectService||_e.resolve("epi.cms.ProjectService");this.currentContentLanguage=this.currentContentLanguage||_13.currentContentLanguage;this.contentDataStore=this.contentDataStore||_e.resolve("epi.storeregistry").get("epi.cms.contentdata");if(!this._contentVersionStore){this._contentVersionStore=_e.resolve("epi.storeregistry").get("epi.cms.contentversion");}this.undoManager=this.undoManager||new _f();this.validator=this.validator||new _15({contextId:this.get("contentLink"),contextTypeName:this.contextTypeName});if(!this.syncService){this._createSyncService();}var _19=_5.hitch(this,function(_1a,_1b,_1c){this.set(_1a,_1c);});this._operation=new _17();this.own(this.syncService.watch("hasPendingChanges",_19),this.validator.watch("isValid",_19),this.validator.watch("hasErrors",_19),this.undoManager.watch("hasUndoSteps",_19),this.undoManager.watch("hasRedoSteps",_19),on(this._operation,"commit",_5.hitch(this,this._commitChanges)));},setActiveProperty:function(_1d){this.onSetActiveProperty(_1d);},suspend:function(){this.set("isSuspended",true);this.onContentChange();this.onSuspend();},onSuspend:function(){},wakeUp:function(){this.set("isSuspended",false);},destroy:function(){this.clear();this.inherited(arguments);},clear:function(){this.undoManager.clear();},_createSyncService:function(){var _1e=new _16({contentLink:this.get("contentLink"),contentDataStore:this.contentDataStore});this.syncService=_1e;},connectLocal:function(_1f,obj,evt,_20){if(!_5.isArray(_1f)){throw Error("First argument to connectLocal must be an Array");}return _1f.push(_2.connect(obj,evt,this,_20));},disconnectLocal:function(_21){if(_5.isArray(_21)){var _22;while((_22=_21.pop())){_2.disconnect(_22);}}},resetNotifications:function(){this.validator.clearErrorsBySource(this.validator.validationSource.client);},beginOperation:function(){this._operation.begin();},endOperation:function(){this._operation.end();},abortOperation:function(){this._operation.abort();},getProperty:function(_23){return this.contentModel.get(_23);},setProperty:function(_24,_25,_26){this._setModelProperty(_24,_25,_26);},forceSaveProperty:function(_27,_28){return this.syncService.forceSaveProperty(_27,_28).then(this.contentModel.set.bind(this.contentModel,_27,_28));},saveAndPublishProperty:function(_29,_2a){return _7(this.syncService.saveAndPublishProperty(_29,_2a),_5.hitch(this,function(_2b){this.contentModel.set(_29,_2a);return _7(_8([this.contentDataStore.refresh(_2b.contentLink),_2b.publishedContentLink?this.contentDataStore.refresh(_2b.publishedContentLink):null]),_5.hitch(this,function(_2c){var _2d=_2c[0];this.set("contentData",_2d);return _2b;}));}));},_commitChanges:function(_2e){var _2f=[];_2e.forEach(function(_30){_2f.push({propertyName:_30.propertyName,value:_30.oldValue,oldValue:_30.value});},this);this.undoManager.createStep(this,this._saveProperties,[_2f],"Edit properties");},_saveProperties:function(_31){this.beginOperation();_1.forEach(_31,function(p){this._setModelProperty(p.propertyName,p.value,p.oldValue);},this);this.endOperation();},_setModelProperty:function(_32,_33,_34){_34=_34===undefined?this.contentModel.get(_32):_34;this.set("isSaved",false);this.contentModel.set(_32,_33);this._operation.save({propertyName:_32,value:_33,oldValue:_34});this.syncService.scheduleForSync(_32,_33);this.enableAutoSave&&this.save();this.onPropertyEdited(_32,_33);},onPropertyEdited:function(_35,_36){},onPropertySaved:function(_37,_38){},onPropertyReverted:function(_39,_3a){this.contentModel.set(_39,_3a);},_onSynchronizeSuccess:function(_3b,_3c,_3d){_1.forEach(_3c,_5.hitch(this,function(_3e){this.validator.clearPropertyErrors(_3e.name,this.validator.validationSource.server);this._patchContentDataStore(_3b,_3e.name,null,_3e.value);this.onPropertySaved(_3e.name,_3e.value);}));this.validator.setGlobalErrors(_3d.validationErrors,this.validator.validationSource.server);},_onSynchronizeFailure:function(_3f,_40,_41,_42){var _43=[];_1.forEach(_40,function(_44){if("successful" in _44){if(_44.successful){this.validator.clearPropertyErrors(_44.name,this.validator.validationSource.server);}else{if(_44.committed){this.validator.setPropertyErrors(_44.name,[{errorMessage:_44.validationErrors,severity:this.validator.severity.error}],this.validator.validationSource.server);}else{_43.push(_44);}}}},this);if(_43.length){var _45=_1.map(_43,function(_46){return _46.validationErrors;});this._showErrorsDialog(res.autosave.title,res.autosave.error,_45,_5.hitch(this,function(){_1.forEach(_43,function(_47){this.onPropertyReverted(_47.name,_47.value);},this);}));}if(_42){if(_42.validationErrors){this.validator.setGlobalErrors(_42.validationErrors,this.validator.validationSource.server);}else{this.validator.clearGlobalErrors(this.validator.validationSource.server);}}},_showErrorsDialog:function(_48,_49,_4a,_4b){var _4c=new (_3([_b,_c]))({className:"epi-grid-max-height--300"});_4c.renderArray(_4a);_4c.startup();new _11({title:_48,description:_49,content:_4c,onAction:_4b}).show();},_contentLinkChanged:function(_4d,_4e){this.set("contentLink",_4e);this.syncService.contentLink=_4e;this.validator.setContextId(_4e);if(!this.get("isSuspended")){var _4f={uri:"epi.cms.contentdata:///"+_4e};_6.publish("/epi/shell/context/request",_4f,{sender:this,contextIdSyncChange:true,trigger:"internal"});}},ensureWritableVersion:function(){var _50=this.get("contentLink");if(!this.contentData.isNewVersionRequired){return _50;}if(this._isCreatingNewVersionDeferred&&!this._isCreatingNewVersionDeferred.isFulfilled()){return this._isCreatingNewVersionDeferred.promise;}else{this._isCreatingNewVersionDeferred=new _4();}this.isCreatingNewVersion=true;_7(this._contentVersionStore.put({originalContentLink:_50}),_5.hitch(this,function(_51){this.contentDataStore.refresh(_51.contentLink).then(_5.hitch(this,function(_52){this.set("contentData",_52);})).always(_5.hitch(this,function(){this.isCreatingNewVersion=false;this._contentLinkChanged(_50,_51.contentLink);this._isCreatingNewVersionDeferred.resolve(_51);}));}),_5.hitch(this,function(_53){console.error(_53);this.isCreatingNewVersion=false;this._isCreatingNewVersionDeferred.reject(_53);}));return this._isCreatingNewVersionDeferred.promise;},validate:function(){var def;if(!this.validator){def=new _4();def.resolve();}else{def=this.validator.validate();}return def;},revertToPublished:function(){var _54=this.get("contentLink");_7(this._contentVersionStore.remove(_54),_5.hitch(this,function(){this._loadPublishedVersion(_54);}),_5.hitch(this,function(_55){var _56;if(_55.status===403){_56=_18.deleteversion.cannotdeletepublished;}else{if(_55.status===404){_56=res.versionstatus.versionnotfound;}}if(_56){new _11({description:_56,onAction:_5.hitch(this,function(){this._loadPublishedVersion(_54);})}).show();}}));},_loadPublishedVersion:function(_57){_7(this._contentVersionStore.query({contentLink:_57,language:this.languageContext?this.languageContext.language:"",query:"getpublishedversion"}),_5.hitch(this,function(_58){if(_58!==null){var _59={uri:"epi.cms.contentdata:///"+_58.contentLink,context:this};_6.publish("/epi/shell/context/request",_59,{sender:this,forceReload:true});}}));},createDraft:function(){var _5a=this.get("contentLink"),_5b=this.contentData.isCommonDraft&&this.contentData.status===_14.versionStatus.DelayedPublish&&!this.projectService.isProjectModeEnabled;return _7(this._contentVersionStore.put({originalContentLink:_5a,isCommonDraft:_5b}),_5.hitch(this,function(_5c){var _5d={uri:"epi.cms.contentdata:///"+_5c.contentLink,context:this};_6.publish("/epi/shell/context/request",_5d,{sender:this});_6.publish("/epi/cms/content/statuschange/","common-draft",{id:_5c.contentLink});}));},editCommonDraft:function(){var _5e=this.get("contentLink");return _7(this._contentVersionStore.query({contentLink:_5e,query:"getcommondraftversion"}),_5.hitch(this,function(_5f){var _60={uri:"epi.cms.contentdata:///"+_5f.contentLink,context:this};_6.publish("/epi/shell/context/request",_60,{sender:this});}));},_populateContentModel:function(_61,_62){var _63={},_64,_65;for(var _66 in _61){var _67=_62.getPropertyMetadata(_66);var _68=_61[_66];if(_67.hasSubProperties()){_63[_66]=this._populateContentModel(_68,_67);}else{_63[_66]=_68;_64=_67.customEditorSettings.converter;if(_64){_65=_10.getConverter(_64,"runtimeType");if(_65){_63[_66]=_65.convert(_64,"runtimeType",_68);}}}}return _63;},getPropertyMetaData:function(_69){return _7(this._getMetadata(),function(_6a){return _6a.getPropertyMetadata(_69);});},reload:function(){return _7(_8([this.contentDataStore.get(this.get("contentLink")),this._getMetadata(true)]),_5.hitch(this,function(_6b){var _6c=_6b[0],_6d=_6b[1];this.set("contentData",_6c);var _6e=this.get("contentModel");var _6f=this._populateContentModel(_6c.properties,_6d);for(var _70 in _6f){if(_6f.hasOwnProperty(_70)&&!_d.areEqual(_6e.get(_70),_6f[_70])){_6e.set(_70,_6f[_70]);}}}));},_getMetadata:function(_71){var _72=this.get("metadata");if(!_71&&_72){return _72;}var _73=this;return _7(this.metadataManager.getMetadataForType("EPiServer.Core.ContentData",{contentLink:this.get("contentLink")}),function(_74){_73.set("metadata",_74);return _74;});},save:function(){if(!this.isOnline){var def=new _4();def.resolve(true);return def;}return this._save();},_save:function(){var def=new _4(),_75=_5.hitch(this,function(_76){if(_76){if(_76.successful){this._onSynchronizeSuccess(_76.contentLink,_76.properties,_76);}else{this._rescheduleProperties(_76.properties);this._onSynchronizeFailure(_76.contentLink,_76.properties,_76.validationErrors,_76);}if(_76&&_76.hasContentLinkChanged){this._contentLinkChanged(_76.contentLink,_76.oldContentLink);}}this.set("isOnline",true);this.set("lastSaved",new Date());this.set("isSaving",false);this.set("isSaved",true);def.resolve(true);}),_77=_5.hitch(this,function(_78){this.set("hasErrors",true);this.set("isSaving",false);this.set("isSaved",false);this.set("isOnline",false);if(_78){this._rescheduleProperties(_78.properties);}setTimeout(_5.hitch(this,function(){this.set("isOnline",true);this._save();}),this._syncRetryTimeout);def.reject(_78);});if(!this.hasPendingChanges){_75();}else{_7(this.ensureWritableVersion()).then(_5.hitch(this,function(){this.set("isSaving",true);return this.syncService.save();})).then(_75).otherwise(_77);}return def;},_rescheduleProperties:function(_79){_1.forEach(_79,_5.hitch(this,function(_7a){if(!this.syncService.pendingSync(_7a.name)){this.syncService.scheduleForSync(_7a.name,_7a.value);}}));},undo:function(){!this.get("isSuspended")&&this.undoManager.undo();},redo:function(){!this.get("isSuspended")&&this.undoManager.redo();},_patchContentDataStore:function(_7b,_7c,_7d,_7e){var _7f={};_5.setObject(_7c,_7e,_7f);return this.contentDataStore.patchCache({contentLink:_7b,changedBy:this.profileHandler.userName,saved:(new Date()).toISOString(),properties:_7f});},changeContentStatus:function(_80){var _81=this.get("contentLink");var def=new _4();this.set("isChangingContentStatus",true);var _82=_5.hitch(this,function(_83){var _84=_83&&_83.success;var _85=this.validator;if(_84){if(_80===_14.action.Publish||_80===_14.action.CheckIn||_80===(_14.saveAction.CheckIn|_14.saveAction.DelayedPublish|_14.saveAction.ForceCurrentVersion)){this.set("lastSaved",null);}if(_85){_85.clearGlobalErrors(_85.validationSource.server);}var _86={id:_83.id,oldId:_81};_6.publish("/epi/cms/content/statuschange/",_80,_86);def.resolve(_86);}else{if(_83&&_83.validationErrors){if(_85){_85.setGlobalErrors(_83.validationErrors,_85.validationSource.server);_85.validate();}def.reject(null);}else{def.reject((_83&&_83.errorMessage)?_83.errorMessage:res.publish.error);}}this.set("isChangingContentStatus",false);});var _87=_5.hitch(this,function(_88){_6.publish("/epi/cms/action/showerror");def.reject((_88&&_88.errorMessage)?_88.errorMessage:res.publish.error);this.set("isChangingContentStatus",false);});this.onContentChange();_7(this.validate(),_5.hitch(this,function(){_7(this.save(),_5.hitch(this,function(){_7(this.contentDataStore.executeMethod("ChangeStatus",this.get("contentLink"),{action:_80}),_82,_87);}),_87);}),_87);return def;},onContentChange:function(){},hasEditAccess:function(){return _14.hasAccess(this.contentData.accessMask,_14.accessLevel.Edit);},hasAccess:function(_89){var _8a=!this.languageContext||!this.languageContext.isTranslationNeeded;return _8a&&_14.isActionAvailable(this.contentData,_89||_14.action.Edit,_14.providerCapabilities.Edit);},canTranslateContent:function(){if(this.viewLanguage&&this.languageContext&&this.viewLanguage!==this.currentContentLanguage){return false;}return true;},canChangeContent:function(_8b){var _8c=this.projectService.isProjectModeEnabled&&this.contentData.isPartOfAnotherProject;return !_8c&&this.canEditCurrentLanguage()&&this.hasAccess(_8b);},canEditCurrentLanguage:function(){if(!this.languageContext){return true;}return this.languageContext.language===this.currentContentLanguage;},_contentDataSetter:function(_8d){this.contentData=_8d;if(_8d.contentLink!==undefined){this.set("contentLink",_8d.contentLink);}},_showOverlayGetter:function(){var _8e=this.getProperty("iversionable_shortcut");if(_8e&&_8e.pageShortcutType){return _8e.pageShortcutType!==4;}return true;}});});