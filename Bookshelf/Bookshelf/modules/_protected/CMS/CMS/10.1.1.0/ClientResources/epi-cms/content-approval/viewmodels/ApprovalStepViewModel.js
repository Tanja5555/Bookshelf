//>>built
define("epi-cms/content-approval/viewmodels/ApprovalStepViewModel",["dojo/_base/declare","epi-cms/content-approval/viewmodels/ApproverViewModel","dojo/Stateful","dojo/Evented","epi/shell/DestroyableByKey","epi-cms/content-approval/command/AddApprovalStep","epi-cms/content-approval/command/RemoveApprovalStep","dojo/store/Memory","dojo/store/Observable","epi/i18n!epi/nls/episerver.cms.contentapproval"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a){return _1([_3,_5,_4],{approvers:null,commands:null,userStore:null,canBeDeleted:true,isReadOnly:false,name:"",isValid:true,validationMessage:null,languages:null,showValidations:false,addApprover:function(_b){_b.languages=_b.languages||[];this.approvers.add(this._createApprover(_b));},filterOutExistingUsers:function(_c){var _d=this.get("approvers");return _c=_c.filter(function(_e){return !_d.get(_e.userName);},this);},filterApprovers:function(_f){this.approvers.query().forEach(function(_10){if(_f===null||_10.languages.length===0){_10.set("canApprove",true);return;}var _11=_10.languages.some(function(_12){return _12===_f;});_10.set("canApprove",_11);});},createApprovalStep:function(){this.emit("create-step",this);},removeApprovalStep:function(){this.emit("remove-step",this);},removeApprover:function(_13){if(this.isReadOnly){return;}this.approvers.remove(_13);},serialize:function(){var _14=this.approvers.data.map(function(_15){return _15.serialize();});return {name:this.name,approvers:_14};},validate:function(){if(!this.approvers){return;}var _16=this.approvers.query(),_17=this._validateApprovers(_16);if(!_17){_17=this._validateLanguages(_16);}this.set("validationMessage",_17);this.set("isValid",!_17);},_createApprover:function(_18){var _19=new _2(_18);this.own(_19.watch("languages",function(){this.validate();this.emit("change");}.bind(this)));this.validate();return _19;},_nameSetter:function(_1a){_1a=_1a||"";if(_1a===this.name){return;}this.name=_1a;this.emit("change");},_nameGetter:function(){return this.name||_a.step.header.placeholder;},_approversSetter:function(_1b){var _1c=_1b.map(function(_1d){return this._createApprover(_1d);},this);this.approvers=_9(new _8({idProperty:"userName",data:_1c}));this.destroyByKey("approversObserveHandle");this.ownByKey("approversObserveHandle",this.approvers.query().observe(function(){this.validate();this.emit("change");}.bind(this)));this.validate();},_commandsGetter:function(){if(this.commands===null){this.commands=[new _6({model:this}),new _7({model:this})];}return this.commands;},_validateLanguages:function(_1e){var _1f=null;if(!this.languages){return _1f;}this.languages.forEach(function(_20){var _21=_1e.some(function(_22){if(_22.languages.length===0){return true;}return _22.languages.some(function(_23){return _23===_20.value;});});if(!_21){if(_1f){_1f.languages.push(_20.value);}else{_1f={value:_a.validationmessage.notenoughlanguagesmessage.title,languages:[_20.value],level:"warning"};}}});return _1f;},_validateApprovers:function(_24){var _25=null;var _26=_24.length>0;if(!_26){_25={value:_a.validationmessage.notenoughapproversmessage.title,languages:null,level:"error"};}return _25;}});});