//>>built
require({cache:{"url:epi-cms/contentediting/editors/templates/TinyMCEEditor.html":"<div id=\"widget_${id}\">\n    <div style=\"display: inline-block\" data-dojo-attach-point=\"stateNode, tooltipNode\">\n        <textarea data-dojo-attach-point=\"editorFrame\" id=\"${id}_editorFrame\" style=\"border: none;\"></textarea>\n    </div>\n    <div data-dojo-attach-point=\"dndOverlay\" style=\"background: rgba(0, 0, 0, 0.01); position: absolute; left: 0; top: 0; right: 0; bottom: 0; display: none\"></div>\n</div>\n"}});define("epi-cms/contentediting/editors/TinyMCEEditor",["dojo/_base/config","dojo/_base/declare","dojo/_base/lang","dojo/_base/window","dojo/dom-style","dojo/dom-class","dojo/dom-construct","dojo/Deferred","dojo/keys","dojo/on","dojo/when","dojo/sniff","dojox/html/entities","dijit/_TemplatedMixin","dijit/focus","epi/routes","epi/shell/conversion/ObjectConverterRegistry","epi/shell/dnd/Target","epi/shell/layout/_LayoutWidget","epi/shell/TypeDescriptorManager","epi/shell/widget/_ValueRequiredMixin","epi-cms/widget/_DndStateMixin","epi-cms/widget/_HasChildDialogMixin","epi-cms/widget/_UserResizable","epi/shell/widget/dialog/Alert","tinymce/tiny_mce_src","dojo/text!./templates/TinyMCEEditor.html","epi/i18n!epi/cms/nls/tinymce","epi/i18n!epi/cms/nls/episerver.tinymce"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,on,_a,_b,_c,_d,_e,_f,_10,_11,_12,_13,_14,_15,_16,_17,_18,_19,_1a,_1b,_1c){_19.addI18n({en:_3.mixin({},_1b,_1c)});return _2([_12,_d,_16,_17,_14,_15],{baseClass:"epiTinyMCEEditor",width:null,height:null,value:null,intermediateChanges:true,templateString:_1a,settings:null,dirtyCheckInterval:2000,autoResizable:false,isResized:false,tinymceRendered:null,dropTarget:null,readOnly:false,_fullScreenEditor:null,_dirtyCheckTimeout:null,_editorValue:null,postMixInProperties:function(){this.inherited(arguments);if(this.autoResizable){this.height=0;}this.tinymceRendered=new _8();},postCreate:function(){this.own(this.dropTarget=new _11(this.dndOverlay,{accept:this.allowedDndTypes,createItemOnDrop:false,readOnly:this.readOnly}));this.connect(this.dropTarget,"onDropData","onDropData");this.connect(this.dndOverlay,"onmousemove","_onOverlayMouseMove");this.inherited(arguments);},startup:function(){if(this._started){return;}this.inherited(arguments);this._initTinyMCE();},destroy:function(){if(_b("trident")){this._refocus();}if(this._destroyed){return;}this._cancelDirtyCheckInterval();var ed=this.getEditor();if(ed&&ed.getParam("fullscreen_is_enabled")){var _1d=_19.get(ed.getParam("fullscreen_editor_id"));_1d.plugins.fullscreen.saveState(ed);}ed&&ed.remove();this.inherited(arguments);},_loadLegacyPlugins:function(){var dfd=new _8();this.legacyPlugins.forEach(function(_1e){var url=_f.getActionPath({moduleArea:"Util",path:"Editor/tinymce/plugins/"+_1e+"/"+(_1.isDebug?"editor_plugin_src.js":"editor_plugin.js")});_19.PluginManager.load(_1e,url);});_19.ScriptLoader.loadQueue(function(){dfd.resolve();});return dfd.promise;},canAccept:function(){return !_6.contains(this.dndOverlay,"dojoDndTargetDisabled");},_onDndStart:function(){_5.set(this.dndOverlay,"display","block");this.inherited(arguments);},_onDndCancel:function(){_5.set(this.dndOverlay,"display","none");this.inherited(arguments);},_onDndDrop:function(){_5.set(this.dndOverlay,"display","none");this.inherited(arguments);},_onOverlayMouseMove:function(evt){this._dragPosition={x:evt.pageX,y:evt.pageY};},onDropData:function(_1f,_20,_21,_22){var _23=_1f?(_1f.length?_1f[0]:_1f):null;if(!_23){return;}if(this.onDropping){this.onDropping();}this._dropDataProcessor(_23);},_dropDataProcessor:function(_24){_a(_24.data,_3.hitch(this,function(_25){var _26=this,_27=_24.type,ed=this.getEditor();function _28(url){ed.focus();ed.execCommand("CreateLink",false,url);};function _29(_2a){ed.focus();if(ed.execCommand("mceInsertContent",false,_2a)){_26._onChange(ed.getContent());}};function _2b(_2c){if(!ed.selection.isCollapsed()){_28(_2c.url);}else{var _2d="<a href=\"{0}\" title=\"{1}\">{1}</a>";_29(_3.replace(_2d,[_2c.url,_c.encode(_2c.text)]));}};function _2e(_2f){var _30="<img alt=\"{alt}\" src=\"{src}\" width=\"{width}\" height=\"{height}\" />";var _31=_2f.previewUrl||_2f.url;var _32=_7.create("img",{src:_31,style:{display:"none;"}},_4.body(),"last");on.once(_32,"load",function(){_29(_3.replace(_30,{alt:this.alt,width:this.width,height:this.height,src:_31}));_7.destroy(_32);});};if(_27&&_27.indexOf("link")!==-1){_2b(_25);return;}else{if(_27&&_27.indexOf("fileurl")!==-1){_2e(_25);return;}}var _33=_25.typeIdentifier;var _34=_13.getValue(_33,"editorDropBehaviour");if(_34){if(_34===1){var _35="<div data-contentlink=\""+_25.contentLink+"\" data-classid=\"36f4349b-8093-492b-b616-05d8964e4c89\" class=\"mceNonEditable epi-contentfragment\">"+_25.name+"</div>";_29(_35);return;}var _36,_37=_13.getInheritanceChain(_33);for(var i=0;i<_37.length;i++){var _38=_37[i];_36=_10.getConverter(_38,_38+".link");if(_36){break;}}if(!_36){return;}_a(_36.convert(_33,_33+".link",_25),_3.hitch(this,function(_39){if(!_39.url){var _3a=new _18({description:_1c.notabletocreatelinkforpage});_3a.show();this.own(_3a);}else{switch(_34){case 2:_2b(_39);break;case 3:_2e(_39);break;}}}));}}));_5.set(this.dndOverlay,{display:"none"});},_onFocus:function(){this.inherited(arguments);this.focus();},focus:function(){var ed=this.getEditor();if(ed){_a(this.tinymceRendered,_3.hitch(this,function(){_e.focus(ed.contentWindow.frameElement);ed.focus();}));}},getEditor:function(){if(typeof _19==="undefined"||_19===null){return null;}var ed=this._fullScreenEditor;if(ed&&ed.id==="mce_fullscreen"){return ed;}return _19.get(this.editorFrame.id);},getEditorDOM:function(){return (typeof _19!=="undefined"&&_19!==null)?_19.DOM:null;},resizeEditor:function(){var ed=this.getEditor(),_3b=0,_3c=(_19.isIE?document.body.clientHeight:window.innerHeight)-200,_3d=(_19.isIE?document.body.clientWidth:window.innerWidth)-200,d=ed.getDoc(),b=d.body,DOM=_19.DOM,_3e=this.height,_3f=this.width,_40,_41;_40=b.scrollHeight;_41=b.scrollWidth;if(_40>_3b){_3e=_40;}if(_40>_3c){_3e=_3c;}if(_41>_3d){_3f=_3d;}DOM.setStyle(ed.contentWindow.frameElement,"height",_3e+80+"px");if(ed.getBody().scrollWidth!==ed.getBody().offsetWidth){var _42=20;if(_3e===_3c){_42=30;}DOM.setStyle(ed.contentWindow.frameElement,"width",ed.getBody().scrollWidth+_42+"px");}this.isResized=true;},_setValueAttr:function(_43){var ed=this.getEditor(),_44=_43||"";this._set("value",_43);if(ed&&ed.initialized){ed.setContent(_44);}else{this.editorFrame.value=_44;}},_updateTinySettings:function(){this.settings=_3.mixin(this.settings,{mode:"exact",width:this.width,height:this.height,relative_urls:false,elements:this.editorFrame.id,readonly:this.readOnly});},_initTinyMCE:function(){this._loadLegacyPlugins().then(function(){this._updateTinySettings();if(this.legacyPlugins&&this.legacyPlugins.length>0){this.settings.plugins=this.settings.plugins+","+this.legacyPlugins.join(",");}if(typeof _19!=="undefined"){_19.dom.Event.domLoaded=true;this._setupHandle=_19.onAddEditor.add(_3.hitch(this,this._onAddEditor));_19.init(this.settings);}else{console.error("Couldn't initialize the editor");}}.bind(this));},_isFullScreen:function(ed){return ed.editorId==="mce_fullscreen";},_onAddEditor:function(_45,ed){if(this.editorFrame&&ed.id===this.editorFrame.id){this._setupEditorEventHandling(_45,ed);}else{if(this.editorFrame&&ed.settings.fullscreen_editor_id===this.editorFrame.id){this._setupEditorEventHandling(_45,ed);this._fullScreenEditor=ed;}}},_handlePopupWindow:function(ed){ed.windowManager.onOpen.add(_3.hitch(this,function(){this.isShowingChildDialog=true;}));var _46=_3.hitch(this,function(){this.focus();this.isShowingChildDialog=this._isFullScreen(ed);if(!this.isShowingChildDialog){this._onChange(ed.getContent());}});ed.windowManager.onClose.add(_3.hitch(this,function(){setTimeout(_46);}));},_handlePopupMenu:function(ed){var _47;for(var i in ed.controlManager.controls){_47=ed.controlManager.controls[i];if(_47.onRenderMenu){_47.onRenderMenu.add(_3.hitch(this,function(_48,_49){_49.onShowMenu.add(_3.hitch(this,function(){this.isShowingChildDialog=true;}));_49.onHideMenu.add(_3.hitch(this,function(){this.isShowingChildDialog=this._isFullScreen(ed);}));}));}}},_setupEditorEventHandling:function(_4a,ed){ed.onInit.add(_3.hitch(this,function(){!this.tinymceRendered.isResolved()&&this.tinymceRendered.resolve();this.own(_e.registerIframe(ed.contentWindow.frameElement));this._handlePopupMenu(ed);this._handlePopupWindow(ed);if(this.autoResizable){setTimeout(_3.hitch(this,this.resizeEditor),200);}else{this.set("isResized",true);}this._startDirtyCheckInterval();if(ed&&ed.selection){ed.selection.onSetContent.add(_3.hitch(this,function(_4b,_4c){var _4d=_4c.set;if(_4d){this._onChange(ed.getContent());}}));}}));ed.onChange.add(_3.hitch(this,function(ed,e){this._onChange(ed.getContent());}));ed.onSetContent.add(_3.hitch(this,"onSetContent"));ed.onRemove.add(_3.hitch(this,"onEditorRemoved"));ed.onRedo.add(_3.hitch(this,"onRedo"));ed.onUndo.add(_3.hitch(this,"onUndo"));ed.onBeforeExecCommand.add(_3.hitch(this,function(ed,cmd,ui,val,a){this._onChange(ed.getContent());if(cmd==="mceFullScreen"&&ed.id!=="mce_fullscreen"){this.isShowingChildDialog=!this._isFullScreen(ed);}else{if(cmd==="mceFullScreen"&&ed.id==="mce_fullscreen"){this._fullScreenEditor=null;}}}));},onSetContent:function(ed,e){var _4e=ed.getContent(),_4f=this.get("_editorValue")!==_4e;e.initial&&this.set("_editorValue",_4e);if(_4f){this.validate();this.onLayoutChanged();}},onEditorRemoved:function(ed){},_isMetaKey:function(e){if(e.keyCode===_9.CTRL||e.keyCode===_9.ALT||e.keyCode===_9.SHIFT||e.keyCode===_9.META){return true;}return false;},_onChange:function(val){var _50=this.get("_editorValue")!==val;if(_50){this._set("value",val);this.set("_editorValue",val);if(this.validate()){this.onChange(val);}}},onChange:function(val){},_stopEditing:function(){var ed=this.getEditor(),val=ed.getContent();this.displayMessage(null);if(ed&&ed.undoManager&&ed.undoManager.typing){ed.undoManager.typing=0;ed.undoManager.add();}this._onChange(val);},_onBlur:function(){this._stopEditing();this.inherited(arguments);},_cancelDirtyCheckInterval:function(){if(this._dirtyCheckTimeout){clearTimeout(this._dirtyCheckTimeout);this._dirtyCheckTimeout=null;}},_startDirtyCheckInterval:function(){if(this._destroyed||!this.intermediateChanges){return;}this._cancelDirtyCheckInterval();this._dirtyCheck();this._dirtyCheckTimeout=setTimeout(_3.hitch(this,this._startDirtyCheckInterval),this.dirtyCheckInterval);},_dirtyCheck:function(){var ed=this.getEditor();var _51=_3.getObject("plugins.spellchecker.active",false,ed)||false;if(ed&&!_51){this._onChange(ed.getContent());}},onRedo:function(ed,_52){},onUndo:function(ed,_53){},_refocus:function(){var _54=document.activeElement;var _55=document.createElement("input");_55.type="text";_55.style.position="absolute";_55.style.left="-9000px";_55.style.height="0";_55.style.width="0";document.getElementsByTagName("body")[0].appendChild(_55);_55.focus();if(_54){_54.focus();}else{_55.blur();}_55.parentNode.removeChild(_55);_55=_54=null;}});});