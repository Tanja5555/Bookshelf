//>>built
define("epi-cms/contentediting/ContentModelServerSync",["dojo/_base/array","dojo/_base/declare","dojo/Deferred","dojo/when","dojo/_base/json","dojo/_base/lang","dojo/Stateful","epi/datetime","epi/string"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9){return _2([_7],{_queue:null,_isSynchronizing:false,hasPendingChanges:false,contentLink:null,contentDataStore:null,processInterval:200,_processIntervalId:0,_saveDeferred:null,constructor:function(_a){_2.safeMixin(this,_a);this._queue=[];},scheduleForSync:function(_b,_c){if(_c===undefined){return;}this.set("hasPendingChanges",true);_c=_8.transformDate(_c);var _d=this._propertyIndexInQueue(_b);if(_d<0){this._queue.push({name:_b,value:_c});}else{this._queue[_d].value=_c;}},forceSaveProperty:function(_e,_f){return this.save().then(function(){this.scheduleForSync(_e,_f);return this._startSynchronizeInterval({delay:0,forceCurrent:true});}.bind(this));},saveAndPublishProperty:function(_10,_11){this.scheduleForSync(_10,_11);return this._startSynchronizeInterval({delay:0,publish:true});},_propertyIndexInQueue:function(_12){var _13=-1;_1.some(this._queue,function(_14,i){if(_14.name===_12){_13=i;return true;}});return _13;},save:function(){return this._startSynchronizeInterval();},_startSynchronizeInterval:function(_15){var _16;if(!this._saveDeferred){this._saveDeferred=new _3();_16=_15&&_15.delay||this.processInterval;setTimeout(this._synchronizeItem.bind(this,_15),_16);}return this._saveDeferred.promise;},_synchronizeItem:function(_17){var _18=this._queue,_19=this.contentLink,_1a=this._saveDeferred;this._queue=[];this._saveDeferred=null;this.set("hasPendingChanges",false);var _1b=function(_1c){var _1d={},_1e;if(_1c){_1.forEach(_1c.properties,_6.hitch(this,function(_1f){_1f.name=_9.pascalToCamel(_1f.name);}));_1e=_1c.savedContentLink;_1d=_6.mixin({successful:false,contentLink:_1c.savedContentLink,hasContentLinkChanged:_1c.savedContentLink&&_1e!==this.contentLink},_1c);if(_1e&&_1e!==this.contentLink){_1d.oldContentLink=this.contentLink;this.contentLink=_1e;}_1a.resolve(_1d);}else{_1a.reject({contentLink:_19,properties:_18,error:"Unexpected result returned from the server."});}}.bind(this);var _20=function(_21){var _22={contentLink:_19,properties:_18,error:_21};_1a.reject(_22);}.bind(this);if(_18.length===0){_1a.resolve();return;}_4(this._saveProperties(_18,_17)).then(_1b).otherwise(_20);},pendingSync:function(_23){return this._propertyIndexInQueue(_23)!==-1;},_saveProperties:function(_24,_25){var _26=this.contentLink,_27={},_28=!!_25&&_25.forceCurrent,_29=!!_25&&_25.publish;_1.forEach(_24,_6.hitch(this,function(_2a){_27[_2a.name]=_5.toJson(_2a.value);}));var _2b={id:_26,properties:_27,publishChanges:_29,forceCurrent:_28};return this.contentDataStore.patch(_2b,{id:_2b.id});}});});